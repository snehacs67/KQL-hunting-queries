Description: Detects devices that connected via TeamViewer or executed TeamViewer for the first time in the last 30 days, which may indicate unauthorized remote access
severity: High

  tactic: Command and Control
        : Persistence
  tactic: Lateral Movement
  technique: T1219 # Remote Access Software
           : T1071 # Application Layer Protocol
           : T1105 # Ingress Tool Transfer

Query: 
  // Devices that connected via TeamViewer in last 30 days
  let RecentConnections = DeviceNetworkEvents
  | where TimeGenerated > ago(30d)
  | where InitiatingProcessFileName =~ "TeamViewer.exe"
  | where ActionType == "ConnectionSuccess"
  | where LocalIPType == "Private" and RemoteIPType == "Public"
  | project DeviceName, TimeGenerated, RemoteIP, RemotePort;

  // Devices where TeamViewer ran for first time in last 30 days
  let FirstTimeExecution = DeviceProcessEvents
  | where TimeGenerated > ago(30d)
  | where FileName =~ "TeamViewer.exe"
  | summarize FirstSeen = min(TimeGenerated) by DeviceName;
